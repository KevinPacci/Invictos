<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Invictos Bet Tracker</title>
    <style>
      :root {
        --bg: #0f1215;
        --surface: #171c22;
        --surface-alt: #1e242c;
        --border: #2a313d;
        --text: #f5f7fa;
        --text-muted: #a1acbd;
        --accent: #3dd598;
        --accent-soft: rgba(61, 213, 152, 0.15);
        --danger: #f36b7f;
        --warning: #ffcc66;
        --shadow: 0 24px 60px rgba(0, 0, 0, 0.35);
        font-family: "Segoe UI", Inter, system-ui, -apple-system, sans-serif;
        line-height: 1.5;
        color: var(--text);
        background-color: var(--bg);
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        min-height: 100vh;
        background: radial-gradient(circle at top right, rgba(61, 213, 152, 0.12), transparent 45%), radial-gradient(circle at bottom left, rgba(66, 133, 244, 0.12), transparent 40%), var(--bg);
      }
      a {
        color: inherit;
      }
      h1, h2, h3 {
        margin: 0;
        line-height: 1.2;
      }
      p {
        margin: 0;
      }
      header.app-header {
        position: sticky;
        top: 0;
        z-index: 10;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1.5rem clamp(1.5rem, 5vw, 3rem);
        background: rgba(15, 18, 21, 0.85);
        backdrop-filter: blur(18px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      }
      header .branding {
        display: grid;
        gap: 0.35rem;
      }
      header .branding h1 {
        font-size: clamp(1.65rem, 3vw, 2.1rem);
        letter-spacing: 0.03em;
      }
      header .branding p {
        color: var(--text-muted);
        font-size: 0.95rem;
      }
      header .header-actions {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
      }
      .ghost-button {
        background: transparent;
        border: 1px solid var(--border);
        color: var(--text);
        border-radius: 999px;
        padding: 0.45rem 1rem;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      .ghost-button:hover {
        border-color: var(--accent);
        color: var(--accent);
      }
      .ghost-button.danger:hover {
        border-color: var(--danger);
        color: var(--danger);
      }
      .ghost-button.small {
        padding: 0.3rem 0.65rem;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }
      main.content {
        display: grid;
        gap: 1.75rem;
        padding: 2rem clamp(1.5rem, 5vw, 3.5rem) 4rem;
      }
      .card {
        background: linear-gradient(145deg, var(--surface), var(--surface-alt));
        border: 1px solid var(--border);
        border-radius: 1.1rem;
        padding: clamp(1.2rem, 3vw, 2rem);
        box-shadow: var(--shadow);
      }
      .summary-panel {
        display: grid;
        gap: 1.5rem;
      }
      .summary-heading {
        display: flex;
        justify-content: space-between;
        gap: 1rem;
        align-items: baseline;
      }
      .summary-heading span {
        color: var(--text-muted);
        font-size: 0.95rem;
        letter-spacing: 0.05em;
        text-transform: uppercase;
      }
      .summary-grid {
        display: grid;
        gap: 1rem;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      }
      .summary-item {
        padding: 1rem;
        border-radius: 0.9rem;
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.04);
        display: grid;
        gap: 0.4rem;
      }
      .summary-item span.label {
        font-size: 0.85rem;
        color: var(--text-muted);
        letter-spacing: 0.06em;
        text-transform: uppercase;
      }
      .summary-item strong {
        font-size: 1.4rem;
        font-weight: 600;
      }
      .summary-item small {
        color: var(--text-muted);
        font-size: 0.8rem;
      }
      .workspace {
        display: grid;
        gap: 1.5rem;
      }
      @media (min-width: 1040px) {
        .workspace {
          grid-template-columns: minmax(320px, 360px) 1fr;
          align-items: start;
        }
      }
      .stack {
        display: grid;
        gap: 1.2rem;
      }
      .section-heading {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.75rem;
        flex-wrap: wrap;
      }
      .section-heading h2 {
        font-size: 1.1rem;
        letter-spacing: 0.04em;
        text-transform: uppercase;
        color: var(--text-muted);
      }
      .section-heading strong {
        font-size: 1rem;
      }
      .field {
        display: grid;
        gap: 0.35rem;
      }
      .field label {
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-muted);
      }
      .field input[type="text"],
      .field input[type="number"],
      .field input[type="date"],
      .field select {
        width: 100%;
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 0.75rem;
        padding: 0.65rem 0.9rem;
        color: var(--text);
        font-size: 0.95rem;
      }
      .field input:focus,
      .field select:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px var(--accent-soft);
      }
      .radio-group {
        display: inline-flex;
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 999px;
        padding: 0.2rem;
        gap: 0.2rem;
      }
      .radio-group label {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.35rem 0.9rem;
        border-radius: 999px;
        cursor: pointer;
        font-size: 0.9rem;
      }
      .radio-group input {
        display: none;
      }
      .radio-group label.active {
        background: rgba(61, 213, 152, 0.15);
        color: var(--accent);
      }
      .parlay-editor {
        display: grid;
        gap: 0.75rem;
        border-radius: 0.9rem;
        border: 1px dashed rgba(255, 255, 255, 0.08);
        padding: 0.9rem;
        background: rgba(255, 255, 255, 0.02);
      }
      .parlay-editor.hidden {
        display: none;
      }
      .legs {
        display: grid;
        gap: 0.6rem;
      }
      .leg-row {
        display: grid;
        gap: 0.6rem;
      }
      .leg-row-inner {
        display: flex;
        gap: 0.6rem;
      }
      .leg-row-inner input[type="text"],
      .leg-row-inner input[type="number"] {
        flex: 1;
      }
      .leg-row-inner input[type="number"] {
        max-width: 140px;
      }
      .icon-button {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.08);
        color: var(--text-muted);
        border-radius: 0.65rem;
        padding: 0.4rem 0.65rem;
        font-size: 0.85rem;
        cursor: pointer;
      }
      .icon-button:hover {
        border-color: var(--accent);
        color: var(--accent);
      }
      .submit-button {
        background: var(--accent);
        color: #051910;
        border: none;
        border-radius: 0.9rem;
        padding: 0.8rem 1.2rem;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        box-shadow: 0 12px 30px rgba(61, 213, 152, 0.35);
      }
      .submit-button:hover {
        transform: translateY(-1px);
      }
      .form-message {
        font-size: 0.85rem;
        letter-spacing: 0.04em;
        text-transform: uppercase;
      }
      .form-message.success {
        color: var(--accent);
      }
      .form-message.error {
        color: var(--danger);
      }
      .bet-list {
        display: grid;
        gap: 1rem;
      }
      .bet-card {
        border-radius: 0.9rem;
        padding: 1rem;
        border: 1px solid rgba(255, 255, 255, 0.05);
        background: rgba(255, 255, 255, 0.03);
        display: grid;
        gap: 0.75rem;
      }
      .bet-header {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 0.6rem;
      }
      .pill {
        font-size: 0.75rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        padding: 0.25rem 0.6rem;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .pill.single {
        color: var(--accent);
        border-color: var(--accent);
      }
      .pill.parlay {
        color: #5ec4ff;
        border-color: #5ec4ff;
      }
      .bet-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        font-size: 0.9rem;
        color: var(--text-muted);
      }
      .bet-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: center;
      }
      .bet-controls label {
        display: grid;
        gap: 0.35rem;
        font-size: 0.75rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--text-muted);
      }
      .bet-controls select,
      .bet-controls input[type="number"] {
        width: 160px;
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 0.6rem;
        padding: 0.45rem 0.6rem;
        color: var(--text);
      }
      details.legs {
        border-top: 1px solid rgba(255, 255, 255, 0.05);
        padding-top: 0.6rem;
        color: var(--text-muted);
      }
      details.legs summary {
        cursor: pointer;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      .legs-list {
        margin: 0.5rem 0 0;
        display: grid;
        gap: 0.4rem;
      }
      .legs-list li {
        list-style: none;
        font-size: 0.9rem;
      }
      .empty-state {
        padding: 1rem;
        border-radius: 0.9rem;
        border: 1px dashed rgba(255, 255, 255, 0.08);
        color: var(--text-muted);
        text-align: center;
      }
      .history {
        display: grid;
        gap: 1.2rem;
      }
      .history-grid {
        display: grid;
        gap: 1rem;
      }
      @media (min-width: 820px) {
        .history-grid {
          grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        }
      }
      .history-card {
        border-radius: 0.9rem;
        padding: 1rem;
        border: 1px solid rgba(255, 255, 255, 0.05);
        background: rgba(255, 255, 255, 0.02);
        display: grid;
        gap: 0.4rem;
      }
      .history-card h3 {
        font-size: 1rem;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        color: var(--text-muted);
      }
      .history-card strong {
        font-size: 1.1rem;
      }
      .history-card small {
        color: var(--text-muted);
        font-size: 0.8rem;
      }
      .daily-topline {
        color: var(--text-muted);
        font-size: 0.9rem;
      }
    </style>
  </head>
  <body>
    <header class="app-header">
      <div class="branding">
        <h1>Invictos bet tracker</h1>
        <p>Control diario, parlays y resumen mensual de resultados.</p>
      </div>
      <div class="header-actions">
        <button type="button" class="ghost-button" id="seedSample">Cargar demo</button>
        <button type="button" class="ghost-button danger" id="clearData">Reset</button>
      </div>
    </header>
    <main class="content">
      <section class="summary-panel card">
        <div class="summary-heading">
          <h2>Resumen mensual</h2>
          <span id="currentMonthLabel"></span>
        </div>
        <div class="summary-grid">
          <article class="summary-item">
            <span class="label">Apostado</span>
            <strong id="metricStake">0</strong>
            <small>Total arriesgado este mes.</small>
          </article>
          <article class="summary-item">
            <span class="label">Retorno</span>
            <strong id="metricReturn">0</strong>
            <small>Incluye cashouts.</small>
          </article>
          <article class="summary-item">
            <span class="label">Ganancia neta</span>
            <strong id="metricNet">0</strong>
            <small>Retorno menos apuesta.</small>
          </article>
          <article class="summary-item">
            <span class="label">Aciertos</span>
            <strong id="metricWins">0</strong>
            <small>Sobre el total registrado.</small>
          </article>
          <article class="summary-item">
            <span class="label">Pendientes</span>
            <strong id="metricPending">0</strong>
            <small>Apuestas sin resultado.</small>
          </article>
          <article class="summary-item">
            <span class="label">Yield</span>
            <strong id="metricYield">0%</strong>
            <small>Ganancia neta / apostado.</small>
          </article>
        </div>
      </section>

      <section class="workspace">
        <section class="card stack">
          <div class="section-heading">
            <h2>Nueva apuesta</h2>
          </div>
          <form id="betForm" autocomplete="off">
            <div class="field">
              <label>Modalidad</label>
              <div class="radio-group" id="modeToggle">
                <label class="active">
                  <input type="radio" name="betMode" value="single" checked />
                  Sencilla
                </label>
                <label>
                  <input type="radio" name="betMode" value="parlay" />
                  Parlay
                </label>
              </div>
            </div>
            <div class="field">
              <label>Detalle</label>
              <input id="betDetail" name="betDetail" type="text" placeholder="Liga - Equipo vs Equipo / Mercado" required />
            </div>
            <div class="field parlay-editor hidden" id="parlayEditor">
              <div class="legs" id="parlayLegs"></div>
              <button type="button" class="icon-button" id="addLeg">Agregar seleccion</button>
              <small style="color: var(--text-muted);">Agrega minimo dos selecciones. La cuota total se calcula automaticamente.</small>
            </div>
            <div class="field">
              <label>Monto apostado</label>
              <input id="betStake" name="betStake" type="number" min="0" step="0.01" placeholder="0.00" required />
            </div>
            <div class="field">
              <label>Cuota</label>
              <input id="betOdds" name="betOdds" type="number" min="1" step="0.01" placeholder="1.00" required />
            </div>
            <div class="field">
              <label>Ganancia / cashout</label>
              <input id="betCashout" name="betCashout" type="number" min="0" step="0.01" placeholder="Automatico segun cuota" />
            </div>
            <div class="field">
              <label>Estado</label>
              <select id="betOutcome" name="betOutcome">
                <option value="acertada">Acertada</option>
                <option value="fallida">Fallida</option>
                <option value="pendiente">Pendiente</option>
              </select>
            </div>
            <button type="submit" class="submit-button">Guardar apuesta</button>
            <p class="form-message" id="formMessage"></p>
          </form>
        </section>

        <section class="card stack">
          <div class="section-heading">
            <h2>Registro diario</h2>
            <div style="display:flex; gap:0.75rem; align-items:center; flex-wrap:wrap;">
              <strong id="selectedDateLabel"></strong>
              <input class="field-input" id="betDate" type="date" />
            </div>
          </div>
          <p class="daily-topline" id="dailyHeadline"></p>
          <div class="bet-list" id="dailyList"></div>
        </section>
      </section>

      <section class="card history">
        <div class="section-heading">
          <h2>Historial mensual</h2>
        </div>
        <div class="history-grid" id="historyList"></div>
      </section>
    </main>

    <template id="legRowTemplate">
      <div class="leg-row">
        <div class="leg-row-inner">
          <input type="text" name="legDetail" placeholder="Seleccion / Mercado" />
          <input type="number" name="legOdds" min="1" step="0.01" placeholder="1.85" />
          <button type="button" class="icon-button remove-leg">x</button>
        </div>
      </div>
    </template>

    <script>
      (function () {
        const stateKey = "invictos-bets-v1";
        const defaultState = { version: 1, bets: {} };
        const monthNames = ["enero", "febrero", "marzo", "abril", "mayo", "junio", "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre"];
        const currencyCode = "USD";
        const currencyFormatter = new Intl.NumberFormat("es-ES", { style: "currency", currency: currencyCode, maximumFractionDigits: 2 });

        const form = document.getElementById("betForm");
        const formMessage = document.getElementById("formMessage");
        const modeToggle = document.getElementById("modeToggle");
        const parlayEditor = document.getElementById("parlayEditor");
        const legContainer = document.getElementById("parlayLegs");
        const legTemplate = document.getElementById("legRowTemplate");
        const addLegButton = document.getElementById("addLeg");
        const detailInput = document.getElementById("betDetail");
        const stakeInput = document.getElementById("betStake");
        const oddsInput = document.getElementById("betOdds");
        const cashoutInput = document.getElementById("betCashout");
        const outcomeSelect = document.getElementById("betOutcome");
        const dateInput = document.getElementById("betDate");

        const metricStake = document.getElementById("metricStake");
        const metricReturn = document.getElementById("metricReturn");
        const metricNet = document.getElementById("metricNet");
        const metricWins = document.getElementById("metricWins");
        const metricPending = document.getElementById("metricPending");
        const metricYield = document.getElementById("metricYield");
        const currentMonthLabel = document.getElementById("currentMonthLabel");
        const dailyList = document.getElementById("dailyList");
        const dailyHeadline = document.getElementById("dailyHeadline");
        const selectedDateLabel = document.getElementById("selectedDateLabel");
        const historyList = document.getElementById("historyList");
        const seedButton = document.getElementById("seedSample");
        const clearButton = document.getElementById("clearData");

        let state = loadState();

        const today = getToday();
        dateInput.value = today;

        modeToggle.addEventListener("change", handleModeChange);
        addLegButton.addEventListener("click", () => addLegRow());
        legContainer.addEventListener("click", handleLegClick);
        legContainer.addEventListener("input", handleLegInput);

        form.addEventListener("submit", handleSubmit);
        dateInput.addEventListener("change", renderAll);

        dailyList.addEventListener("change", handleDailyChange);
        dailyList.addEventListener("click", handleDailyClick);

        seedButton.addEventListener("click", seedDemoData);
        clearButton.addEventListener("click", clearAllData);

        renderAll();

        function loadState() {
          try {
            const raw = localStorage.getItem(stateKey);
            if (!raw) {
              return freshState();
            }
            const parsed = JSON.parse(raw);
            if (!parsed || typeof parsed !== "object" || !parsed.version) {
              return freshState();
            }
            return parsed;
          } catch (error) {
            console.warn("No se pudo cargar el estado guardado", error);
            return freshState();
          }
        }

        function freshState() {
          return JSON.parse(JSON.stringify(defaultState));
        }

        function saveState() {
          localStorage.setItem(stateKey, JSON.stringify(state));
        }

        function getToday() {
          return new Date().toISOString().slice(0, 10);
        }

        function getMonthKey(dateStr) {
          return dateStr.slice(0, 7);
        }

        function ensureMonth(monthId) {
          if (!state.bets[monthId]) {
            state.bets[monthId] = { days: {} };
          }
          return state.bets[monthId];
        }

        function getEntriesForDay(dateStr) {
          const month = state.bets[getMonthKey(dateStr)];
          if (!month) {
            return [];
          }
          return month.days[dateStr] ? month.days[dateStr].slice() : [];
        }

        function addEntry(dateStr, entry) {
          const month = ensureMonth(getMonthKey(dateStr));
          if (!month.days[dateStr]) {
            month.days[dateStr] = [];
          }
          month.days[dateStr].push(entry);
        }

        function handleModeChange(event) {
          if (event.target.name !== "betMode") {
            return;
          }
          const mode = event.target.value;
          updateModeToggle(mode);
          if (mode === "parlay") {
            parlayEditor.classList.remove("hidden");
            if (!legContainer.children.length) {
              addLegRow();
              addLegRow();
            }
            oddsInput.readOnly = true;
            oddsInput.placeholder = "Calculado segun selecciones";
            updateParlayOdds();
          } else {
            parlayEditor.classList.add("hidden");
            oddsInput.readOnly = false;
            oddsInput.placeholder = "1.00";
            oddsInput.value = "";
            legContainer.innerHTML = "";
          }
        }

        function updateModeToggle(mode) {
          [...modeToggle.querySelectorAll("label")].forEach((label) => {
            const input = label.querySelector("input");
            const active = input && input.value === mode && input.checked;
            label.classList.toggle("active", active);
          });
        }

        function addLegRow(initial = {}) {
          const clone = legTemplate.content.cloneNode(true);
          const row = clone.querySelector(".leg-row");
          const detail = row.querySelector('input[name="legDetail"]');
          const odds = row.querySelector('input[name="legOdds"]');
          if (initial.detail) {
            detail.value = initial.detail;
          }
          if (initial.odds) {
            odds.value = formatNumber(initial.odds);
          }
          legContainer.appendChild(clone);
          updateParlayOdds();
        }

        function handleLegClick(event) {
          if (!event.target.classList.contains("remove-leg")) {
            return;
          }
          const row = event.target.closest(".leg-row");
          if (!row) {
            return;
          }
          row.remove();
          updateParlayOdds();
        }

        function handleLegInput(event) {
          if (event.target.name === "legOdds") {
            updateParlayOdds();
          }
        }

        function updateParlayOdds() {
          const legs = collectLegs();
          if (!legs.length) {
            oddsInput.value = "";
            return;
          }
          const total = legs.reduce((acc, leg) => acc * leg.odds, 1);
          oddsInput.value = formatNumber(total);
        }

        function collectLegs() {
          const rows = [...legContainer.querySelectorAll(".leg-row")];
          return rows.map((row) => {
            const detail = row.querySelector('input[name="legDetail"]');
            const odds = row.querySelector('input[name="legOdds"]');
            return {
              detail: (detail.value || "").trim(),
              odds: parseFloat(odds.value),
            };
          }).filter((leg) => leg.detail && Number.isFinite(leg.odds) && leg.odds > 1);
        }

        function handleSubmit(event) {
          event.preventDefault();
          const mode = form.betMode.value;
          const detail = detailInput.value.trim();
          const stake = parseFloat(stakeInput.value);
          const odds = parseFloat(oddsInput.value);
          const cashoutValue = parseFloat(cashoutInput.value);
          const cashout = Number.isFinite(cashoutValue) ? cashoutValue : null;
          const outcome = outcomeSelect.value;
          const selectedDate = dateInput.value || getToday();

          if (!detail) {
            return showFormMessage("Completa el detalle.", "error");
          }
          if (!Number.isFinite(stake) || stake <= 0) {
            return showFormMessage("Ingresa un monto valido.", "error");
          }
          if (!Number.isFinite(odds) || odds <= 1) {
            return showFormMessage("La cuota debe ser mayor a 1.", "error");
          }

          let legs = [];
          if (mode === "parlay") {
            legs = collectLegs();
            if (legs.length < 2) {
              return showFormMessage("Un parlay necesita al menos dos selecciones.", "error");
            }
          }

          const entry = {
            id: generateId("bet"),
            type: mode,
            detail,
            stake,
            odds,
            cashout,
            outcome,
            legs: legs.map((leg) => ({ id: generateId("leg"), ...leg })),
            createdAt: new Date().toISOString(),
          };

          addEntry(selectedDate, entry);
          saveState();
          renderAll();
          form.reset();
          parlayEditor.classList.add("hidden");
          legContainer.innerHTML = "";
          updateModeToggle("single");
          oddsInput.readOnly = false;
          oddsInput.placeholder = "1.00";
          showFormMessage("Apuesta guardada.", "success");
        }

        function showFormMessage(message, type) {
          formMessage.textContent = message;
          formMessage.className = "form-message " + type;
          if (type === "success") {
            setTimeout(() => {
              if (formMessage.textContent === message) {
                formMessage.textContent = "";
                formMessage.className = "form-message";
              }
            }, 2800);
          }
        }

        function handleDailyChange(event) {
          const action = event.target.dataset.action;
          if (!action) {
            return;
          }
          const card = event.target.closest(".bet-card");
          if (!card) {
            return;
          }
          const betId = card.dataset.id;
          const currentDate = dateInput.value || getToday();
          if (action === "updateOutcome") {
            updateEntry(currentDate, betId, { outcome: event.target.value });
          }
          if (action === "updateCashout") {
            const value = parseFloat(event.target.value);
            updateEntry(currentDate, betId, { cashout: Number.isFinite(value) ? value : null });
          }
        }

        function handleDailyClick(event) {
          const action = event.target.dataset.action;
          if (!action) {
            return;
          }
          const card = event.target.closest(".bet-card");
          if (!card) {
            return;
          }
          const betId = card.dataset.id;
          const currentDate = dateInput.value || getToday();
          if (action === "removeBet") {
            removeEntry(currentDate, betId);
          }
        }

        function updateEntry(dateStr, betId, changes) {
          const month = state.bets[getMonthKey(dateStr)];
          if (!month) {
            return;
          }
          const list = month.days[dateStr];
          if (!Array.isArray(list)) {
            return;
          }
          const entry = list.find((item) => item.id === betId);
          if (!entry) {
            return;
          }
          Object.assign(entry, changes);
          saveState();
          renderAll();
        }

        function removeEntry(dateStr, betId) {
          const monthKey = getMonthKey(dateStr);
          const month = state.bets[monthKey];
          if (!month) {
            return;
          }
          const list = month.days[dateStr];
          if (!Array.isArray(list)) {
            return;
          }
          const index = list.findIndex((item) => item.id === betId);
          if (index === -1) {
            return;
          }
          list.splice(index, 1);
          if (!list.length) {
            delete month.days[dateStr];
          }
          if (!Object.keys(month.days).length) {
            delete state.bets[monthKey];
          }
          saveState();
          renderAll();
        }

        function renderAll() {
          const activeDate = dateInput.value || getToday();
          const currentMonthKey = getMonthKey(activeDate);
          renderMonthSummary(currentMonthKey);
          renderDaily(activeDate);
          renderHistory(currentMonthKey);
        }

        function renderMonthSummary(monthKey) {
          const label = monthLabel(monthKey);
          currentMonthLabel.textContent = label;
          const metrics = computeMonthMetrics(monthKey);
          metricStake.textContent = formatCurrency(metrics.stakeTotal);
          metricReturn.textContent = formatCurrency(metrics.returnTotal);
          metricNet.textContent = formatCurrency(metrics.net);
          metricWins.textContent = metrics.wins + " / " + metrics.total;
          metricPending.textContent = String(metrics.pending);
          metricYield.textContent = metrics.stakeTotal > 0 ? formatPercent(metrics.net / metrics.stakeTotal) : "0%";
        }

        function renderDaily(dateStr) {
          const entries = getEntriesForDay(dateStr);
          selectedDateLabel.textContent = formatDateLabel(dateStr);

          if (!entries.length) {
            dailyHeadline.textContent = "Sin apuestas registradas para este dia.";
            dailyList.innerHTML = "";
            dailyList.appendChild(createEmptyState("Agrega una apuesta para comenzar el seguimiento de este dia."));
            return;
          }

          const dayMetrics = entries.reduce((acc, entry) => {
            acc.count += 1;
            acc.stake += entry.stake || 0;
            acc.returnTotal += resolveReturn(entry);
            acc.net += resolveNet(entry);
            if (entry.outcome === "acertada") acc.wins += 1;
            if (entry.outcome === "fallida") acc.losses += 1;
            if (entry.outcome === "pendiente") acc.pending += 1;
            return acc;
          }, { count: 0, stake: 0, returnTotal: 0, net: 0, wins: 0, losses: 0, pending: 0 });

          const summaryParts = [
            dayMetrics.count + (dayMetrics.count === 1 ? " apuesta" : " apuestas"),
            "apostado " + formatCurrency(dayMetrics.stake),
            "retorno " + formatCurrency(dayMetrics.returnTotal),
            "neto " + formatCurrency(dayMetrics.net)
          ];
          dailyHeadline.textContent = summaryParts.join(" | ");

          dailyList.innerHTML = "";
          entries.forEach((entry) => {
            dailyList.appendChild(buildBetCard(entry));
          });
        }

        function renderHistory(currentMonthKey) {
          const months = Object.keys(state.bets).sort().reverse();
          historyList.innerHTML = "";
          const otherMonths = months.filter((key) => key !== currentMonthKey);
          if (!otherMonths.length) {
            historyList.appendChild(createEmptyState("Cuando cierres un mes, seguira disponible aqui."));
            return;
          }
          otherMonths.forEach((monthKey) => {
            const metrics = computeMonthMetrics(monthKey);
            const card = document.createElement("article");
            card.className = "history-card";
            const netClass = metrics.net >= 0 ? "color: var(--accent);" : "color: var(--danger);";
            card.innerHTML = `
              <h3>${escapeHtml(monthLabel(monthKey))}</h3>
              <strong style="${netClass}">${formatCurrency(metrics.net)}</strong>
              <small>Apostado: ${formatCurrency(metrics.stakeTotal)}</small>
              <small>Retorno: ${formatCurrency(metrics.returnTotal)}</small>
              <small>Aciertos: ${metrics.wins} / ${metrics.total}</small>
              <small>Yield: ${metrics.stakeTotal > 0 ? formatPercent(metrics.net / metrics.stakeTotal) : "0%"}</small>
            `;
            historyList.appendChild(card);
          });
        }

        function createEmptyState(message) {
          const div = document.createElement("div");
          div.className = "empty-state";
          div.textContent = message;
          return div;
        }

        function buildBetCard(entry) {
          const card = document.createElement("article");
          card.className = "bet-card";
          card.dataset.id = entry.id;

          const header = document.createElement("div");
          header.className = "bet-header";
          const pill = document.createElement("span");
          pill.className = "pill " + entry.type;
          pill.textContent = entry.type === "parlay" ? "Parlay" : "Sencilla";
          const title = document.createElement("h3");
          title.textContent = entry.detail;
          header.appendChild(pill);
          header.appendChild(title);

          const meta = document.createElement("div");
          meta.className = "bet-meta";
          const odds = document.createElement("span");
          odds.textContent = "Cuota " + formatNumber(entry.odds);
          const stake = document.createElement("span");
          stake.textContent = "Stake " + formatCurrency(entry.stake);
          const ret = document.createElement("span");
          ret.textContent = "Retorno " + formatCurrency(resolveReturn(entry));
          const net = document.createElement("span");
          const netValue = resolveNet(entry);
          net.textContent = "Neto " + formatCurrency(netValue);
          net.style.color = netValue >= 0 ? "var(--accent)" : "var(--danger)";
          meta.appendChild(odds);
          meta.appendChild(stake);
          meta.appendChild(ret);
          meta.appendChild(net);

          const controls = document.createElement("div");
          controls.className = "bet-controls";

          const outcomeLabel = document.createElement("label");
          outcomeLabel.textContent = "Estado";
          const outcomeSelect = document.createElement("select");
          outcomeSelect.dataset.action = "updateOutcome";
          ["acertada", "fallida", "pendiente"].forEach((value) => {
            const option = document.createElement("option");
            option.value = value;
            option.textContent = capitalize(value);
            if (entry.outcome === value) {
              option.selected = true;
            }
            outcomeSelect.appendChild(option);
          });
          outcomeLabel.appendChild(outcomeSelect);

          const cashoutLabel = document.createElement("label");
          cashoutLabel.textContent = "Retorno / cashout";
          const cashoutField = document.createElement("input");
          cashoutField.type = "number";
          cashoutField.step = "0.01";
          cashoutField.dataset.action = "updateCashout";
          cashoutField.placeholder = "Automatico";
          cashoutField.value = Number.isFinite(entry.cashout) ? entry.cashout : "";
          cashoutLabel.appendChild(cashoutField);

          const removeBtn = document.createElement("button");
          removeBtn.type = "button";
          removeBtn.dataset.action = "removeBet";
          removeBtn.className = "ghost-button small";
          removeBtn.textContent = "Eliminar";

          controls.appendChild(outcomeLabel);
          controls.appendChild(cashoutLabel);
          controls.appendChild(removeBtn);

          card.appendChild(header);
          card.appendChild(meta);
          card.appendChild(controls);

          if (entry.type === "parlay" && entry.legs && entry.legs.length) {
            const details = document.createElement("details");
            details.className = "legs";
            const summary = document.createElement("summary");
            summary.textContent = "Ver selecciones (" + entry.legs.length + ")";
            const list = document.createElement("ul");
            list.className = "legs-list";
            entry.legs.forEach((leg, index) => {
              const item = document.createElement("li");
              item.textContent = (index + 1) + ". " + leg.detail + " • " + formatNumber(leg.odds);
              list.appendChild(item);
            });
            details.appendChild(summary);
            details.appendChild(list);
            card.appendChild(details);
          }

          return card;
        }

        function computeMonthMetrics(monthKey) {
          const month = state.bets[monthKey];
          if (!month) {
            return { stakeTotal: 0, returnTotal: 0, net: 0, wins: 0, losses: 0, pending: 0, total: 0 };
          }
          return Object.values(month.days).reduce((acc, entries) => {
            entries.forEach((entry) => {
              const stake = entry.stake || 0;
              const ret = resolveReturn(entry);
              const net = ret - stake;
              acc.stakeTotal += stake;
              acc.returnTotal += ret;
              acc.net += net;
              acc.total += 1;
              if (entry.outcome === "acertada") acc.wins += 1;
              if (entry.outcome === "fallida") acc.losses += 1;
              if (entry.outcome === "pendiente") acc.pending += 1;
            });
            return acc;
          }, { stakeTotal: 0, returnTotal: 0, net: 0, wins: 0, losses: 0, pending: 0, total: 0 });
        }

        function resolveReturn(entry) {
          if (Number.isFinite(entry.cashout)) {
            return entry.cashout;
          }
          if (entry.outcome === "acertada") {
            return (entry.stake || 0) * (entry.odds || 0);
          }
          return 0;
        }

        function resolveNet(entry) {
          return resolveReturn(entry) - (entry.stake || 0);
        }

        function formatCurrency(value) {
          return currencyFormatter.format(value || 0);
        }

        function formatPercent(value) {
          const percentage = (value || 0) * 100;
          const rounded = Math.round(percentage * 10) / 10;
          const isWhole = Math.abs(rounded % 1) < 0.0001;
          const str = isWhole ? rounded.toFixed(0) : rounded.toFixed(1);
          return str + "%";
        }

        function formatNumber(value) {
          return Number(value || 0).toFixed(2);
        }

        function formatDateLabel(dateStr) {
          const [year, month, day] = dateStr.split("-");
          const monthName = monthNames[Number(month) - 1] || "";
          return day + " " + monthName + " " + year;
        }

        function monthLabel(monthKey) {
          const [year, month] = monthKey.split("-");
          const monthName = monthNames[Number(month) - 1] || monthKey;
          return monthName + " " + year;
        }

        function capitalize(text) {
          return text.charAt(0).toUpperCase() + text.slice(1);
        }

        function escapeHtml(value) {
          return String(value).replace(/[&<>"']/g, function (char) {
            const map = { "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;" };
            return map[char] || char;
          });
        }

        function generateId(prefix) {
          return prefix + "-" + Math.random().toString(36).slice(2, 9);
        }

        function seedDemoData() {
          state = {
            version: 1,
            bets: {
              "2025-09": {
                days: {
                  "2025-09-24": [
                    {
                      id: generateId("bet"),
                      type: "single",
                      detail: "Serie A - Inter vs Milan, over 2.5 goles",
                      stake: 80,
                      odds: 1.92,
                      cashout: null,
                      outcome: "acertada",
                      legs: [],
                      createdAt: new Date().toISOString()
                    },
                    {
                      id: generateId("bet"),
                      type: "parlay",
                      detail: "Parlay liga MX sabado",
                      stake: 40,
                      odds: 3.25,
                      cashout: null,
                      outcome: "pendiente",
                      legs: [
                        { id: generateId("leg"), detail: "America gana vs Cruz Azul", odds: 1.55 },
                        { id: generateId("leg"), detail: "Monterrey +1.5 goles", odds: 1.75 },
                        { id: generateId("leg"), detail: "Toluca doble oportunidad", odds: 1.2 }
                      ],
                      createdAt: new Date().toISOString()
                    }
                  ],
                  "2025-09-23": [
                    {
                      id: generateId("bet"),
                      type: "single",
                      detail: "NFL - Ravens ML vs Bengals",
                      stake: 100,
                      odds: 1.68,
                      cashout: 0,
                      outcome: "fallida",
                      legs: [],
                      createdAt: new Date().toISOString()
                    }
                  ]
                }
              },
              "2025-08": {
                days: {
                  "2025-08-18": [
                    {
                      id: generateId("bet"),
                      type: "single",
                      detail: "Premier League - Arsenal gana y ambos anotan",
                      stake: 60,
                      odds: 3.1,
                      cashout: 186,
                      outcome: "acertada",
                      legs: [],
                      createdAt: new Date().toISOString()
                    }
                  ],
                  "2025-08-22": [
                    {
                      id: generateId("bet"),
                      type: "parlay",
                      detail: "Parlay MLS viernes",
                      stake: 35,
                      odds: 4.6,
                      cashout: null,
                      outcome: "fallida",
                      legs: [
                        { id: generateId("leg"), detail: "LAFC + over 1.5 goles", odds: 1.9 },
                        { id: generateId("leg"), detail: "Inter Miami gana", odds: 1.65 },
                        { id: generateId("leg"), detail: "Atlanta United +0.5", odds: 1.45 }
                      ],
                      createdAt: new Date().toISOString()
                    }
                  ]
                }
              }
            }
          };
          saveState();
          renderAll();
          showFormMessage("Datos de ejemplo cargados.", "success");
        }

        function clearAllData() {
          const confirmed = confirm("Se borraran todos los registros. Continuar?");
          if (!confirmed) {
            return;
          }
          state = freshState();
          saveState();
          renderAll();
          showFormMessage("Todo limpio.", "success");
        }
      })();
    </script>
  </body>
</html>
